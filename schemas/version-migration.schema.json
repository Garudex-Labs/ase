{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://ase-protocol.org/schemas/version-migration.schema.json",
  "title": "Version Migration",
  "description": "Schema for ASE version migration procedures and compatibility tracking",
  "definitions": {
    "migrationPath": {
      "type": "object",
      "description": "Migration path between two versions",
      "required": ["fromVersion", "toVersion", "migrationType", "steps"],
      "properties": {
        "fromVersion": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Source version"
        },
        "toVersion": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Target version"
        },
        "migrationType": {
          "type": "string",
          "enum": ["upgrade", "downgrade"],
          "description": "Type of migration"
        },
        "steps": {
          "type": "array",
          "description": "Ordered list of migration steps",
          "items": {
            "$ref": "#/definitions/migrationStep"
          },
          "minItems": 1
        },
        "prerequisites": {
          "type": "array",
          "description": "Prerequisites for migration",
          "items": {
            "type": "string"
          }
        },
        "rollbackProcedure": {
          "$ref": "#/definitions/rollbackProcedure"
        },
        "estimatedDuration": {
          "type": "string",
          "description": "Estimated migration duration (ISO 8601 duration)",
          "pattern": "^P(?:\\d+Y)?(?:\\d+M)?(?:\\d+D)?(?:T(?:\\d+H)?(?:\\d+M)?(?:\\d+S)?)?$"
        },
        "riskLevel": {
          "type": "string",
          "enum": ["low", "medium", "high"],
          "description": "Risk level of migration"
        }
      }
    },
    "migrationStep": {
      "type": "object",
      "description": "Individual migration step",
      "required": ["stepNumber", "description", "action"],
      "properties": {
        "stepNumber": {
          "type": "integer",
          "minimum": 1,
          "description": "Step sequence number"
        },
        "description": {
          "type": "string",
          "description": "Human-readable step description"
        },
        "action": {
          "type": "string",
          "enum": [
            "update_schema",
            "deploy_code",
            "migrate_data",
            "validate_compatibility",
            "enable_feature",
            "disable_feature",
            "archive_data",
            "run_tests"
          ],
          "description": "Type of action to perform"
        },
        "command": {
          "type": "string",
          "description": "Command or script to execute"
        },
        "validation": {
          "type": "object",
          "description": "Validation criteria for step completion",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["test", "check", "verify"]
            },
            "criteria": {
              "type": "string",
              "description": "Success criteria"
            }
          }
        },
        "rollbackAction": {
          "type": "string",
          "description": "Action to rollback this step"
        },
        "optional": {
          "type": "boolean",
          "default": false,
          "description": "Whether this step is optional"
        }
      }
    },
    "rollbackProcedure": {
      "type": "object",
      "description": "Rollback procedure for migration",
      "required": ["steps"],
      "properties": {
        "steps": {
          "type": "array",
          "description": "Ordered list of rollback steps",
          "items": {
            "$ref": "#/definitions/migrationStep"
          }
        },
        "dataPreservation": {
          "type": "array",
          "description": "Data to preserve during rollback",
          "items": {
            "type": "string"
          }
        },
        "estimatedDuration": {
          "type": "string",
          "description": "Estimated rollback duration (ISO 8601 duration)"
        }
      }
    },
    "featureTransition": {
      "type": "object",
      "description": "Feature transition during migration",
      "required": ["featureName", "transitionType"],
      "properties": {
        "featureName": {
          "type": "string",
          "description": "Name of feature being transitioned"
        },
        "transitionType": {
          "type": "string",
          "enum": ["added", "removed", "modified", "deprecated"],
          "description": "Type of transition"
        },
        "fromState": {
          "type": "string",
          "enum": ["unavailable", "available", "deprecated"],
          "description": "Feature state in source version"
        },
        "toState": {
          "type": "string",
          "enum": ["unavailable", "available", "deprecated"],
          "description": "Feature state in target version"
        },
        "migrationStrategy": {
          "type": "string",
          "enum": ["enable", "disable", "convert", "archive"],
          "description": "Strategy for transitioning feature"
        },
        "dataTransformation": {
          "type": "object",
          "description": "Data transformation required for feature",
          "properties": {
            "required": {
              "type": "boolean",
              "description": "Whether data transformation is required"
            },
            "description": {
              "type": "string",
              "description": "Description of transformation"
            },
            "script": {
              "type": "string",
              "description": "Script to perform transformation"
            }
          }
        }
      }
    },
    "compatibilityMatrix": {
      "type": "object",
      "description": "Compatibility matrix between versions",
      "required": ["version1", "version2", "compatible"],
      "properties": {
        "version1": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "version2": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "compatible": {
          "type": "boolean",
          "description": "Whether versions are compatible"
        },
        "compatibilityLevel": {
          "type": "string",
          "enum": ["full", "partial", "degraded", "none"],
          "description": "Level of compatibility"
        },
        "limitations": {
          "type": "array",
          "description": "Compatibility limitations",
          "items": {
            "type": "string"
          }
        },
        "degradedFeatures": {
          "type": "array",
          "description": "Features that operate in degraded mode",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "migrationStatus": {
      "type": "object",
      "description": "Status of ongoing migration",
      "required": ["migrationId", "fromVersion", "toVersion", "status"],
      "properties": {
        "migrationId": {
          "type": "string",
          "description": "Unique migration identifier"
        },
        "fromVersion": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "toVersion": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "status": {
          "type": "string",
          "enum": ["pending", "in_progress", "completed", "failed", "rolled_back"],
          "description": "Current migration status"
        },
        "startedAt": {
          "type": "string",
          "format": "date-time",
          "description": "Migration start timestamp"
        },
        "completedAt": {
          "type": "string",
          "format": "date-time",
          "description": "Migration completion timestamp"
        },
        "currentStep": {
          "type": "integer",
          "minimum": 1,
          "description": "Current step number"
        },
        "totalSteps": {
          "type": "integer",
          "minimum": 1,
          "description": "Total number of steps"
        },
        "errors": {
          "type": "array",
          "description": "Errors encountered during migration",
          "items": {
            "type": "object",
            "properties": {
              "step": {
                "type": "integer"
              },
              "error": {
                "type": "string"
              },
              "timestamp": {
                "type": "string",
                "format": "date-time"
              }
            }
          }
        }
      }
    }
  },
  "oneOf": [
    {
      "title": "Migration Path",
      "$ref": "#/definitions/migrationPath"
    },
    {
      "title": "Feature Transition",
      "$ref": "#/definitions/featureTransition"
    },
    {
      "title": "Compatibility Matrix",
      "$ref": "#/definitions/compatibilityMatrix"
    },
    {
      "title": "Migration Status",
      "$ref": "#/definitions/migrationStatus"
    }
  ]
}
