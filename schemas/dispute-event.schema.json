{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://ase-protocol.org/schemas/dispute-event.schema.json",
  "title": "Dispute Event",
  "description": "Dispute event for charge reconciliation and billing discrepancy resolution",
  "type": "object",
  "required": ["disputeId", "originalChargeId", "disputingAgent", "respondingAgent", "disputeReason", "disputeCategory", "status", "createdAt"],
  "properties": {
    "disputeId": {
      "type": "string",
      "description": "Unique dispute identifier (format: disp_*)",
      "minLength": 1,
      "maxLength": 255,
      "pattern": "^disp_[a-zA-Z0-9_-]+$"
    },
    "originalChargeId": {
      "type": "string",
      "description": "Reference to the charge event being disputed",
      "minLength": 1,
      "maxLength": 255,
      "pattern": "^evt_(prov|final|adj|ref)_[a-zA-Z0-9_-]+$"
    },
    "disputingAgent": {
      "type": "string",
      "description": "Agent ID initiating the dispute",
      "minLength": 1,
      "maxLength": 255
    },
    "respondingAgent": {
      "type": "string",
      "description": "Agent ID responsible for the original charge",
      "minLength": 1,
      "maxLength": 255
    },
    "disputeReason": {
      "type": "string",
      "description": "Human-readable explanation of the dispute",
      "minLength": 1,
      "maxLength": 5000
    },
    "disputeCategory": {
      "type": "string",
      "description": "Category of dispute for classification and routing",
      "enum": ["billing_error", "service_quality", "unauthorized_charge", "pricing_discrepancy", "technical_failure", "other"]
    },
    "evidence": {
      "type": "array",
      "description": "Supporting evidence for the dispute",
      "items": {
        "$ref": "#/definitions/evidence"
      },
      "minItems": 0,
      "maxItems": 50
    },
    "status": {
      "type": "string",
      "description": "Current status of the dispute in its lifecycle",
      "enum": ["open", "under_review", "pending_evidence", "resolved", "escalated", "closed", "withdrawn"]
    },
    "resolution": {
      "$ref": "#/definitions/disputeResolution",
      "description": "Resolution details (present when status is resolved or closed)"
    },
    "createdAt": {
      "type": "string",
      "description": "ISO 8601 timestamp when the dispute was created",
      "format": "date-time"
    },
    "updatedAt": {
      "type": "string",
      "description": "ISO 8601 timestamp when the dispute was last updated",
      "format": "date-time"
    },
    "escalationDetails": {
      "$ref": "#/definitions/escalationDetails",
      "description": "Escalation information (present when status is escalated)"
    },
    "escrowAmount": {
      "$ref": "monetary-amount.schema.json#",
      "description": "Amount held in escrow during dispute resolution"
    },
    "metadata": {
      "type": "object",
      "description": "Optional additional metadata for context-specific information",
      "additionalProperties": true,
      "properties": {
        "priority": {
          "type": "string",
          "description": "Priority level for dispute resolution",
          "enum": ["low", "normal", "high", "urgent"]
        },
        "expectedResolutionTime": {
          "type": "string",
          "description": "Expected time for resolution",
          "format": "date-time"
        },
        "internalNotes": {
          "type": "string",
          "description": "Internal notes for dispute tracking",
          "maxLength": 10000
        },
        "externalReference": {
          "type": "string",
          "description": "External ticket or case reference",
          "maxLength": 255
        }
      }
    }
  },
  "additionalProperties": false,
  "definitions": {
    "evidence": {
      "type": "object",
      "description": "Evidence item supporting the dispute",
      "required": ["evidenceId", "evidenceType", "description", "timestamp"],
      "properties": {
        "evidenceId": {
          "type": "string",
          "description": "Unique evidence identifier",
          "minLength": 1,
          "maxLength": 255
        },
        "evidenceType": {
          "type": "string",
          "description": "Type of evidence",
          "enum": ["log_entry", "transaction_record", "screenshot", "document", "witness_statement", "system_metric", "audit_trail", "other"]
        },
        "description": {
          "type": "string",
          "description": "Description of the evidence",
          "minLength": 1,
          "maxLength": 2000
        },
        "timestamp": {
          "type": "string",
          "description": "When the evidence was collected or occurred",
          "format": "date-time"
        },
        "contentUri": {
          "type": "string",
          "description": "URI to the evidence content (optional)",
          "format": "uri",
          "maxLength": 2048
        },
        "contentHash": {
          "type": "string",
          "description": "Cryptographic hash of evidence content for integrity verification",
          "pattern": "^[a-fA-F0-9]{64}$"
        },
        "submittedBy": {
          "type": "string",
          "description": "Agent ID that submitted this evidence",
          "minLength": 1,
          "maxLength": 255
        }
      },
      "additionalProperties": false
    },
    "disputeResolution": {
      "type": "object",
      "description": "Resolution details for a dispute",
      "required": ["resolutionId", "outcome", "resolvedAt", "resolvedBy"],
      "properties": {
        "resolutionId": {
          "type": "string",
          "description": "Unique resolution identifier",
          "minLength": 1,
          "maxLength": 255,
          "pattern": "^res_[a-zA-Z0-9_-]+$"
        },
        "outcome": {
          "type": "string",
          "description": "Resolution outcome",
          "enum": ["dispute_upheld", "dispute_rejected", "partial_refund", "full_refund", "charge_adjusted", "no_action_required"]
        },
        "resolutionReason": {
          "type": "string",
          "description": "Explanation of the resolution decision",
          "minLength": 1,
          "maxLength": 5000
        },
        "adjustmentAmount": {
          "$ref": "monetary-amount.schema.json#",
          "description": "Monetary adjustment resulting from resolution (if applicable)"
        },
        "resolvedAt": {
          "type": "string",
          "description": "When the dispute was resolved",
          "format": "date-time"
        },
        "resolvedBy": {
          "type": "string",
          "description": "Agent or arbitrator ID that resolved the dispute",
          "minLength": 1,
          "maxLength": 255
        },
        "settlementInstructions": {
          "type": "object",
          "description": "Instructions for settlement execution",
          "properties": {
            "action": {
              "type": "string",
              "description": "Settlement action to perform",
              "enum": ["refund", "adjust_charge", "release_escrow", "transfer_funds", "no_action"]
            },
            "targetAgent": {
              "type": "string",
              "description": "Agent receiving the settlement",
              "minLength": 1,
              "maxLength": 255
            },
            "amount": {
              "$ref": "monetary-amount.schema.json#",
              "description": "Settlement amount"
            },
            "executionDeadline": {
              "type": "string",
              "description": "Deadline for executing settlement",
              "format": "date-time"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "escalationDetails": {
      "type": "object",
      "description": "Details about dispute escalation",
      "required": ["escalatedAt", "escalatedTo", "escalationReason"],
      "properties": {
        "escalatedAt": {
          "type": "string",
          "description": "When the dispute was escalated",
          "format": "date-time"
        },
        "escalatedBy": {
          "type": "string",
          "description": "Agent ID that initiated escalation",
          "minLength": 1,
          "maxLength": 255
        },
        "escalatedTo": {
          "type": "string",
          "description": "Arbitration agent or service ID",
          "minLength": 1,
          "maxLength": 255
        },
        "escalationReason": {
          "type": "string",
          "description": "Reason for escalation",
          "minLength": 1,
          "maxLength": 2000
        },
        "escalationLevel": {
          "type": "integer",
          "description": "Level of escalation (1 = first level, 2 = second level, etc.)",
          "minimum": 1,
          "maximum": 5
        },
        "previousArbitrators": {
          "type": "array",
          "description": "List of previous arbitrators in escalation chain",
          "items": {
            "type": "string",
            "minLength": 1,
            "maxLength": 255
          },
          "maxItems": 5
        }
      },
      "additionalProperties": false
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "status": {
            "enum": ["resolved", "closed"]
          }
        }
      },
      "then": {
        "required": ["resolution"]
      }
    },
    {
      "if": {
        "properties": {
          "status": {
            "const": "escalated"
          }
        }
      },
      "then": {
        "required": ["escalationDetails"]
      }
    }
  ]
}
