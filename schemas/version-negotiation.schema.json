{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://ase-protocol.org/schemas/version-negotiation.schema.json",
  "title": "Version Negotiation",
  "description": "Version negotiation request and response for ASE protocol compatibility",
  "definitions": {
    "versionString": {
      "type": "string",
      "description": "Semantic version string (major.minor.patch)",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "examples": ["0.1.0", "1.0.0", "2.0.0"]
    },
    "featureSet": {
      "type": "object",
      "description": "Feature capabilities for a specific version",
      "properties": {
        "backwardCompatibility": {
          "type": "boolean",
          "description": "Supports backward compatibility with non-ASE agents"
        },
        "provisionalCharges": {
          "type": "boolean",
          "description": "Supports provisional charge events"
        },
        "delegationTokens": {
          "type": "boolean",
          "description": "Supports delegation token authorization"
        },
        "disputeResolution": {
          "type": "boolean",
          "description": "Supports dispute events and resolution workflows"
        },
        "auditBundles": {
          "type": "boolean",
          "description": "Supports cryptographically signed audit bundles"
        },
        "chargeReconciliation": {
          "type": "boolean",
          "description": "Supports charge reconciliation between provisional and final"
        }
      },
      "additionalProperties": true
    },
    "versionCapability": {
      "type": "object",
      "description": "Version with its supported features",
      "required": ["version", "features"],
      "properties": {
        "version": {
          "$ref": "#/definitions/versionString"
        },
        "features": {
          "$ref": "#/definitions/featureSet"
        },
        "deprecated": {
          "type": "boolean",
          "description": "Whether this version is deprecated",
          "default": false
        },
        "sunsetDate": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 date when this version will no longer be supported"
        }
      }
    },
    "negotiationRequest": {
      "type": "object",
      "description": "Version negotiation request from initiating agent",
      "required": ["supportedVersions", "preferredVersion"],
      "properties": {
        "supportedVersions": {
          "type": "array",
          "description": "List of ASE versions supported by the requesting agent",
          "items": {
            "$ref": "#/definitions/versionCapability"
          },
          "minItems": 1
        },
        "preferredVersion": {
          "$ref": "#/definitions/versionString",
          "description": "Preferred version for communication"
        },
        "requiredFeatures": {
          "type": "array",
          "description": "Features that must be supported",
          "items": {
            "type": "string"
          }
        },
        "optionalFeatures": {
          "type": "array",
          "description": "Features that are desired but not required",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "negotiationResponse": {
      "type": "object",
      "description": "Version negotiation response from receiving agent",
      "required": ["selectedVersion", "supportedFeatures"],
      "properties": {
        "selectedVersion": {
          "$ref": "#/definitions/versionString",
          "description": "Negotiated version for communication"
        },
        "supportedFeatures": {
          "$ref": "#/definitions/featureSet",
          "description": "Features available in the selected version"
        },
        "degradedFeatures": {
          "type": "array",
          "description": "Features that will operate in degraded mode",
          "items": {
            "type": "string"
          }
        },
        "unsupportedFeatures": {
          "type": "array",
          "description": "Requested features that are not supported",
          "items": {
            "type": "string"
          }
        },
        "fallbackBehavior": {
          "type": "string",
          "enum": ["ignore", "error", "degrade"],
          "description": "How unsupported features will be handled"
        }
      }
    },
    "versionMismatch": {
      "type": "object",
      "description": "Version mismatch error details",
      "required": ["requestedVersion", "supportedVersions", "reason"],
      "properties": {
        "requestedVersion": {
          "$ref": "#/definitions/versionString"
        },
        "supportedVersions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/versionString"
          }
        },
        "reason": {
          "type": "string",
          "enum": [
            "version_not_supported",
            "required_features_unavailable",
            "version_deprecated",
            "incompatible_major_version"
          ]
        },
        "message": {
          "type": "string",
          "description": "Human-readable error message"
        },
        "suggestedVersion": {
          "$ref": "#/definitions/versionString",
          "description": "Suggested compatible version"
        }
      }
    }
  },
  "oneOf": [
    {
      "title": "Negotiation Request",
      "$ref": "#/definitions/negotiationRequest"
    },
    {
      "title": "Negotiation Response",
      "$ref": "#/definitions/negotiationResponse"
    },
    {
      "title": "Version Mismatch Error",
      "$ref": "#/definitions/versionMismatch"
    }
  ]
}
