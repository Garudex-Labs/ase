{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://ase-protocol.org/schemas/audit-bundle.schema.json",
  "title": "Audit Bundle",
  "description": "Cryptographically signed collection of transaction records for compliance and audit trail verification",
  "type": "object",
  "required": ["bundleId", "generatedBy", "generatedAt", "timeRange", "transactions", "summary", "signature", "signatureAlgorithm"],
  "properties": {
    "bundleId": {
      "type": "string",
      "description": "Unique audit bundle identifier (format: audit_*)",
      "minLength": 1,
      "maxLength": 255,
      "pattern": "^audit_[a-zA-Z0-9_-]+$"
    },
    "generatedBy": {
      "type": "string",
      "description": "Agent ID that generated this audit bundle",
      "minLength": 1,
      "maxLength": 255
    },
    "generatedAt": {
      "type": "string",
      "description": "ISO 8601 timestamp when the bundle was generated",
      "format": "date-time"
    },
    "timeRange": {
      "type": "object",
      "description": "Time range covered by this audit bundle",
      "required": ["startTime", "endTime"],
      "properties": {
        "startTime": {
          "type": "string",
          "description": "Start of the audit period",
          "format": "date-time"
        },
        "endTime": {
          "type": "string",
          "description": "End of the audit period",
          "format": "date-time"
        }
      },
      "additionalProperties": false
    },
    "transactions": {
      "type": "array",
      "description": "Economic events included in this audit bundle",
      "items": {
        "$ref": "#/definitions/economicEvent"
      },
      "minItems": 0,
      "maxItems": 10000
    },
    "summary": {
      "type": "object",
      "description": "Summary statistics for the audit bundle",
      "required": ["totalTransactions", "totalAmount", "agentParticipants"],
      "properties": {
        "totalTransactions": {
          "type": "integer",
          "description": "Total number of transactions in the bundle",
          "minimum": 0
        },
        "totalAmount": {
          "$ref": "monetary-amount.schema.json#",
          "description": "Total monetary amount across all transactions"
        },
        "agentParticipants": {
          "type": "array",
          "description": "List of agent IDs involved in transactions",
          "items": {
            "type": "string",
            "minLength": 1,
            "maxLength": 255
          },
          "uniqueItems": true
        },
        "transactionsByType": {
          "type": "object",
          "description": "Count of transactions by event type",
          "properties": {
            "provisional": {
              "type": "integer",
              "minimum": 0
            },
            "final": {
              "type": "integer",
              "minimum": 0
            },
            "adjustment": {
              "type": "integer",
              "minimum": 0
            },
            "refund": {
              "type": "integer",
              "minimum": 0
            },
            "dispute": {
              "type": "integer",
              "minimum": 0
            }
          },
          "additionalProperties": false
        },
        "amountByAgent": {
          "type": "object",
          "description": "Total amounts by agent ID",
          "additionalProperties": {
            "$ref": "monetary-amount.schema.json#"
          }
        },
        "amountByCurrency": {
          "type": "object",
          "description": "Total amounts by currency",
          "additionalProperties": {
            "type": "string",
            "pattern": "^\\d+(\\.\\d{1,10})?$"
          }
        }
      },
      "additionalProperties": false
    },
    "signature": {
      "type": "string",
      "description": "Base64-encoded cryptographic signature of the bundle content",
      "pattern": "^[A-Za-z0-9+/]+=*$",
      "minLength": 1
    },
    "signatureAlgorithm": {
      "type": "string",
      "description": "Cryptographic algorithm used for signing",
      "enum": ["ES256", "RS256", "ES384", "RS384", "ES512", "RS512"]
    },
    "publicKeyId": {
      "type": "string",
      "description": "Key identifier for signature verification",
      "minLength": 1,
      "maxLength": 255
    },
    "previousBundleId": {
      "type": "string",
      "description": "Reference to previous audit bundle for chain continuity",
      "minLength": 1,
      "maxLength": 255,
      "pattern": "^audit_[a-zA-Z0-9_-]+$"
    },
    "previousBundleHash": {
      "type": "string",
      "description": "Cryptographic hash of previous bundle for tamper detection",
      "pattern": "^[a-fA-F0-9]{64}$"
    },
    "metadata": {
      "type": "object",
      "description": "Optional additional metadata for audit context",
      "additionalProperties": true,
      "properties": {
        "auditPurpose": {
          "type": "string",
          "description": "Purpose of this audit bundle",
          "enum": ["periodic_report", "compliance_audit", "dispute_evidence", "reconciliation", "investigation", "other"]
        },
        "complianceFramework": {
          "type": "string",
          "description": "Compliance framework this audit addresses",
          "maxLength": 255
        },
        "retentionPeriod": {
          "type": "integer",
          "description": "Required retention period in days",
          "minimum": 1
        },
        "encryptionStatus": {
          "type": "string",
          "description": "Encryption status of bundle content",
          "enum": ["unencrypted", "encrypted_at_rest", "encrypted_in_transit", "fully_encrypted"]
        },
        "accessControl": {
          "type": "array",
          "description": "List of agent IDs authorized to access this bundle",
          "items": {
            "type": "string",
            "minLength": 1,
            "maxLength": 255
          },
          "uniqueItems": true
        }
      }
    },
    "integrityChecks": {
      "type": "object",
      "description": "Additional integrity verification data",
      "properties": {
        "merkleRoot": {
          "type": "string",
          "description": "Merkle tree root hash for transaction integrity",
          "pattern": "^[a-fA-F0-9]{64}$"
        },
        "transactionHashes": {
          "type": "array",
          "description": "Individual transaction hashes for verification",
          "items": {
            "type": "string",
            "pattern": "^[a-fA-F0-9]{64}$"
          }
        },
        "checksumAlgorithm": {
          "type": "string",
          "description": "Algorithm used for checksums",
          "enum": ["SHA256", "SHA384", "SHA512"]
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false,
  "definitions": {
    "economicEvent": {
      "type": "object",
      "description": "Economic event record in the audit trail",
      "required": ["eventId", "eventType", "timestamp", "agentId", "amount"],
      "properties": {
        "eventId": {
          "type": "string",
          "description": "Unique event identifier",
          "minLength": 1,
          "maxLength": 255
        },
        "eventType": {
          "type": "string",
          "description": "Type of economic event",
          "enum": ["cost_declaration", "budget_request", "provisional_charge", "final_charge", "adjustment", "refund", "dispute", "resolution"]
        },
        "timestamp": {
          "type": "string",
          "description": "ISO 8601 timestamp when the event occurred",
          "format": "date-time"
        },
        "agentId": {
          "type": "string",
          "description": "Agent ID associated with this event",
          "minLength": 1,
          "maxLength": 255
        },
        "amount": {
          "$ref": "monetary-amount.schema.json#",
          "description": "Monetary amount for this event"
        },
        "currency": {
          "type": "string",
          "description": "ISO 4217 currency code",
          "pattern": "^[A-Z]{3}$"
        },
        "metadata": {
          "type": "object",
          "description": "Event-specific metadata",
          "additionalProperties": true
        },
        "auditTrail": {
          "type": "array",
          "description": "Audit trail entries for this event",
          "items": {
            "$ref": "#/definitions/auditEntry"
          }
        },
        "relatedEventIds": {
          "type": "array",
          "description": "IDs of related events (e.g., provisional charge for a final charge)",
          "items": {
            "type": "string",
            "minLength": 1,
            "maxLength": 255
          }
        }
      },
      "additionalProperties": false
    },
    "auditEntry": {
      "type": "object",
      "description": "Individual audit trail entry",
      "required": ["entryId", "timestamp", "action", "performedBy"],
      "properties": {
        "entryId": {
          "type": "string",
          "description": "Unique audit entry identifier",
          "minLength": 1,
          "maxLength": 255
        },
        "timestamp": {
          "type": "string",
          "description": "When the action occurred",
          "format": "date-time"
        },
        "action": {
          "type": "string",
          "description": "Action performed",
          "minLength": 1,
          "maxLength": 255
        },
        "performedBy": {
          "type": "string",
          "description": "Agent ID that performed the action",
          "minLength": 1,
          "maxLength": 255
        },
        "details": {
          "type": "object",
          "description": "Additional details about the action",
          "additionalProperties": true
        },
        "previousState": {
          "type": "object",
          "description": "State before the action",
          "additionalProperties": true
        },
        "newState": {
          "type": "object",
          "description": "State after the action",
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    }
  }
}
